1. 订单表创建单库30个分表
2. 对用户ID和30进行取模，取模结果决定了记录存到第几个分表
3. 查询时同样对用户ID和30进行取模，决定查询第几个分表

每个分表数据太多会影响性能



直接增加分表，会打乱原来的哈希规则

30个分表增加到80个分表，但需要进行数据迁移

## 一致性哈希

一致性哈希主要用于分布式缓存中，解决分布式存储结构下动态增加或删除节点所带来的问题。

1. 把空间做成一个环形结构，分成2的32次方个缓存区，redis中则是分成16384个slot

2. 每个key作哈希求出哈希值，根据哈希值可以将key映射到环的一个位置

3. 将存储节点也作哈希求值，同样映射到环的一个位置

4. 如何存储key值呢，在环形空间中，将key值存储到顺时针离key最近的节点上



### 增加节点

一小部分key的归属会受到影响。

### 删除节点



### 问题

如何解决数据分布不均匀？

引入虚拟节点，做法是增加编号#N再进行哈希，虚拟节点数量足够时，可以保证大概均匀

hash漂移

某个节点失效，于是缓存都漂到下个节点；过一会它又恢复了，这时它可能会有旧值，带来脏数据

如何解决呢，每个节点做成集群方案，保证高可用